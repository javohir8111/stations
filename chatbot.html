<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RailSafe AI - Aqlli Temir Yo'l Yordamchisi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0a2540 0%, #0056a0 100%);
            --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            --ai-gradient: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            --user-bubble: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            --bot-bubble: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            --dark-bg: #1a1a1a;
            --dark-text: #f8f9fa;
            --shadow-light: 0 15px 40px rgba(0, 0, 0, 0.15);
            --shadow-dark: 0 15px 40px rgba(0, 0, 0, 0.3);
            --accent-color: #ffd700;
            --border-radius: 30px;
            --transition: all 0.3s ease;
            --wave-color: #ffd700;
            --glow-color: rgba(255, 215, 0, 0.5);
        }

        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #0a2540 100%);
            --success-gradient: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
            --ai-gradient: linear-gradient(135deg, #5a32a3 0%, #c71f7a 100%);
            --user-bubble: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
            --bot-bubble: linear-gradient(135deg, #343a40 0%, #495057 100%);
            --dark-bg: #f8f9fa;
            --dark-text: #212529;
            --shadow-light: 0 15px 40px rgba(0, 0, 0, 0.3);
            --shadow-dark: 0 15px 40px rgba(255, 255, 255, 0.1);
            --wave-color: #ffffff;
            --glow-color: rgba(255, 255, 255, 0.5);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: var(--primary-gradient);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            transition: var(--transition);
            color: var(--dark-text);
            overflow: hidden;
        }

        .chat-container {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            overflow: hidden;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: var(--transition);
        }

        [data-theme="dark"] .chat-container {
            background: rgba(26, 26, 26, 0.95);
            box-shadow: var(--shadow-dark);
            border-color: rgba(0, 0, 0, 0.3);
        }

        .chat-header {
            background: var(--success-gradient);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
        }

        .chat-header h1 {
            margin: 0;
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .chat-header img.logo {
            height: 50px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }

        .chat-header img.logo:hover {
            transform: rotate(360deg) scale(1.1);
            transition: transform 0.5s ease;
        }

        .chat-header p {
            margin: 8px 0 0;
            opacity: 0.95;
            font-size: 1rem;
            font-style: italic;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: var(--transition);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .voice-btn {
            background: var(--ai-gradient);
            animation: ai-glow 2s infinite alternate;
        }

        @keyframes ai-glow {
            from { box-shadow: 0 0 5px rgba(111, 66, 193, 0.5); }
            to { box-shadow: 0 0 20px rgba(111, 66, 193, 0.8); }
        }

        .voice-btn.listening {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
            animation: pulse 0.8s infinite, wave 1.5s infinite;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.8);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        @keyframes wave {
            0% { box-shadow: 0 0 0 0 var(--glow-color); }
            70% { box-shadow: 0 0 0 10px transparent; }
            100% { box-shadow: 0 0 0 0 transparent; }
        }

        .clear-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .clear-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        }

        .forecast-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .forecast-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        }

        .theme-toggle {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
        }

        .theme-toggle:hover {
            background: linear-gradient(135deg, #5a32a3 0%, #4c2990 100%);
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            background: rgba(248, 249, 250, 0.9);
            scroll-behavior: smooth;
            position: relative;
            transition: var(--transition);
        }

        [data-theme="dark"] .messages {
            background: rgba(26, 26, 26, 0.9);
            color: var(--dark-text);
        }

        .message {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            animation: fadeInSlide 0.5s ease-out;
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .bubble {
            background: var(--user-bubble);
            color: white;
            border-radius: 25px 25px 5px 25px;
            padding: 15px 20px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.25);
            position: relative;
            font-weight: 400;
            font-size: 1rem;
        }

        .bot-message .bubble {
            background: var(--bot-bubble);
            color: #212529;
            border-radius: 25px 25px 25px 5px;
            padding: 15px 20px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            font-weight: 400;
            font-size: 1rem;
        }

        [data-theme="dark"] .bot-message .bubble {
            background: var(--bot-bubble);
            color: #f8f9fa;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin: 0 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
        }

        .avatar:hover {
            transform: scale(1.05);
        }

        .user-avatar {
            background: var(--user-bubble);
            color: white;
        }

        .bot-avatar {
            background: var(--ai-gradient);
            color: white;
        }

        .bot-avatar.speaking {
            animation: speakingWave 1s infinite;
            box-shadow: 0 0 15px var(--glow-color);
        }

        @keyframes speakingWave {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px var(--glow-color); }
            100% { transform: scale(1); }
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: var(--bot-bubble);
            border-radius: 25px 25px 25px 5px;
            max-width: 80%;
            margin: 0 60px 25px 0;
            align-self: flex-start;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .typing-indicator {
            background: var(--bot-bubble);
        }

        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .typing-dots span {
            height: 10px;
            width: 10px;
            background: #6c757d;
            border-radius: 50%;
            animation: typing 1.2s infinite ease-in-out;
        }

        [data-theme="dark"] .typing-dots span {
            background: #adb5bd;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .input-area {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(222, 226, 230, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: var(--transition);
        }

        [data-theme="dark"] .input-area {
            background: rgba(26, 26, 26, 0.95);
            border-top-color: rgba(73, 80, 87, 0.5);
        }

        .voice-input-btn {
            background: var(--ai-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .voice-input-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(111, 66, 193, 0.4);
        }

        .voice-input-btn.listening {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);
            animation: pulse 0.6s infinite, wave 1.5s infinite;
        }

        .messages::-webkit-scrollbar {
            width: 8px;
        }

        .messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        [data-theme="dark"] .messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                border-radius: 0;
                padding: 0;
            }
            .chat-header {
                padding: 20px 15px;
            }
            .chat-header h1 {
                font-size: 1.8rem;
                gap: 10px;
            }
            .chat-header img.logo {
                height: 40px;
            }
            .controls {
                gap: 10px;
            }
            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
            .messages {
                padding: 20px 15px;
            }
            .message .bubble {
                max-width: 90%;
                padding: 14px 18px;
            }
            .avatar {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
                margin: 0 10px;
            }
            .input-area {
                padding: 15px;
                gap: 10px;
            }
            .voice-input-btn {
                width: 60px;
                height: 60px;
                font-size: 1.6rem;
            }
            .typing-indicator {
                margin: 0 50px 20px 0;
                padding: 14px 18px;
            }
        }

        @media (max-width: 480px) {
            .chat-header h1 {
                font-size: 1.5rem;
            }
            .chat-header p {
                font-size: 0.9rem;
            }
            .controls {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }
        }

        .message.loading .bubble {
            animation: loadingPulse 1.5s infinite;
        }

        @keyframes loadingPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="chat-container">
        <div class="chat-header">
            <h1 id="chat-title"><img src="railsafe.png" alt="RailSafe Logo" class="logo"> RailSafe AI</h1>
            <p id="chat-subtitle">Aqlli temir yo'l yordamchisi — temir yo'l xavfsizligi va diagnostikasi bo'yicha mutaxassis!</p>
            <div class="controls">
                <button class="control-btn forecast-btn" id="forecastBtn" onclick="getForecast()" title="Ob-havo bashorati"><i class="fas fa-cloud-sun"></i></button>
                <button class="control-btn clear-btn" onclick="clearChat()" title="Chatni tozalash"><i class="fas fa-trash"></i></button>
                <button class="control-btn theme-toggle" onclick="toggleTheme()" title="Tema o'zgartirish"><i class="fas fa-moon"></i></button>
            </div>
        </div>
        <div class="messages" id="messages"></div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <span id="typing-text" style="margin-left: 15px;">Yozmoqdaman...</span>
        </div>
        <div class="input-area">
            <button class="voice-input-btn" id="voiceBtn" title="Ovoz bilan gapirish"><i class="fas fa-microphone"></i></button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const translations = {
            uz: {
                title: "<img src='railsafe.png' alt='Logo' class='logo'> RailSafe AI",
                subtitle: "Aqlli temir yo'l yordamchisi — temir yo'l xavfsizligi va diagnostikasi bo'yicha mutaxassis! <i class='fas fa-shield-alt'></i>",
                typing: "AI yozmoqdaman...",
                initial: "Salom! Men RailSafe AI man, temir yo'l xavfsizligi va diagnostikasi bo'yicha mutaxassis. Men faqat o'zbek tilida mukammal gaplashaman. Savollaringizni ovoz bilan bering, men ovoz bilan javob beraman. Misol uchun, temir yo'l stansiyalari, poyezdlar jadvali, ob-havo bashoratlari, diagnostika holati haqida so'rang. Boshlaymizmi?",
                responses: {
                    salom: ["Salom! RailSafe tizimiga xush kelibsiz. Temir yo'l xavfsizligi va diagnostikasi haqida savollaringizni kutaman. <i class='fas fa-question-circle'></i>"],
                    assalomu_alaykum: ["Va alaykum assalom! RailSafe AI sizga temir yo'l masalalarida yordam beradi. Nima bilmoqchisiz? <i class='fas fa-handshake'></i>"],
                    xayr: ["Xayr! Temir yo'l xavfsizligiga e'tiborli bo'ling. Yana savollaringiz bo'lsa, qaytib keling! <i class='fas fa-wave-hand'></i>"],
                    stansiya: ["Qaysi stansiya haqida ma'lumot kerak? Masalan: Toshkent, Samarqand, Buxoro, Navoiy yoki boshqalar. <i class='fas fa-map-marker-alt'></i>"],
                    toshkent: ["Toshkent stansiyasi: Markaziy temir yo'l uzeli. Real vaqt monitoring: normal. Harorat: 25°C. Poyezdlar soni: 25 ta. Kechikishlar: yo'q. <i class='fas fa-thermometer-quarter'></i>"],
                    samarqand: ["Samarqand stansiyasi: Tarixiy uzel. Diagnostika: stabil. Harorat: 24°C. O'tgan poyezdlar: 18 ta. Tez orada yangi poyezdlar. <i class='fas fa-sun'></i>"],
                    buxoro: ["Buxoro stansiyasi: Ipak yo'li nuqtasi. Holat: normal. Harorat: 26°C. Log: stabil. Poyezdlar tezligi: o'rtacha. <i class='fas fa-balance-scale'></i>"],
                    navoiy: ["Navoiy stansiyasi: Navoiy viloyatida joylashgan. Holat: yaxshi. Harorat: 27°C. O'tgan poyezdlar: 20 ta. <i class='fas fa-map-pin'></i>"],
                    jizzax: ["Jizzax stansiyasi: Jizzax viloyatida. Diagnostika: normal. Harorat: 25°C. Poyezdlar: 15 ta. <i class='fas fa-train-subway'></i>"],
                    guliston: ["Guliston stansiyasi: Sirdaryo viloyatida. Holat: stabil. Harorat: 26°C. <i class='fas fa-cloud'></i>"],
                    kungrad: ["Kungrad stansiyasi: Qoraqalpog'istonda. Holat: yaxshi. Harorat: 28°C. <i class='fas fa-desert'></i>"],
                    urgench: ["Urganch stansiyasi: Xorazm viloyatida. Diagnostika: normal. Harorat: 27°C. <i class='fas fa-water'></i>"],
                    andijon: ["Andijon stansiyasi: Andijon viloyatida. Holat: stabil. Harorat: 24°C. <i class='fas fa-mountain'></i>"],
                    fargona: ["Farg'ona stansiyasi: Farg'ona viloyatida. Holat: yaxshi. Harorat: 25°C. <i class='fas fa-leaf'></i>"],
                    termiz: ["Termiz stansiyasi: Surxondaryo viloyatida. Diagnostika: normal. Harorat: 29°C. <i class='fas fa-sun-dust'></i>"],
                    qarshi: ["Qarshi stansiyasi: Qashqadaryo viloyatida. Holat: stabil. Harorat: 28°C. <i class='fas fa-road'></i>"],
                    nukus: ["Nukus stansiyasi: Qoraqalpog'istonda. Holat: yaxshi. Harorat: 27°C. <i class='fas fa-city'></i>"],
                    xiva: ["Xiva stansiyasi: Xorazm viloyatida. Diagnostika: normal. Harorat: 26°C. <i class='fas fa-monument'></i>"],
                    poyezd: ["Poyezd haqida: Toshkent-Samarqand yo'nalishida kuniga 10 ta poyezd. Jadval yoki holatni aniqlashtiring. Boshqa yo'nalishlar: Toshkent-Andijon, Samarqand-Buxoro. <i class='fas fa-train'></i>"],
                    jadval: ["Bugungi jadval: Toshkentdan Samarqandga 08:00, 12:00, 18:00. Kechikish: yo'q. Boshqa jadval uchun stansiyani ayting. <i class='fas fa-clock'></i>"],
                    o_tgan_poyezdlar: ["Bugun chap tomonda 12 ta, o'ng tomonda 15 ta poyezd o'tdi. Umumiy: 27 ta. Tez orada yangi statistika. <i class='fas fa-chart-line'></i>"],
                    diagnostika: ["Diagnostika: Chap tizim normal (42°C), o'ng tizim ogohlantirish (65°C). Umumiy holat: stabil. Tez orada tekshiruv. <i class='fas fa-tools'></i>"],
                    holat: ["Tizim holati: Oxirgi tekshiruv 14:30. Ish vaqti: 48 soat. Alarm: yo'q. Hamma narsa nazorat ostida. <i class='fas fa-check-circle'></i>"],
                    xavfsizlik: ["Xavfsizlik: Sensorlar harorat va balansni kuzatadi. Har qanday muammo ogohlantiriladi. Xavfsizlik maslahatlari: Harorat oshishiga e'tibor bering. <i class='fas fa-shield-alt'></i>"],
                    sensor: ["Sensorlar yangilandi. Harorat oshishi aniqlandi, lekin normalga qaytdi. Yangi sensorlar o'rnatilmoqda. <i class='fas fa-thermometer-half'></i>"],
                    log: ["Oxirgi loglar: Aloqa tiklandi, sensor yangilandi. To'liq log uchun stansiya ayting. Loglar arxivi mavjud. <i class='fas fa-file-alt'></i>"],
                    voqea: ["Voqealar: Balans buzilishi hal qilindi. Hammasi normal. Yangi voqealar: yo'q. <i class='fas fa-exclamation-triangle'></i>"],
                    yordam: ["Men RailSafe haqida yordam beraman: stansiyalar, poyezdlar, diagnostika, ob-havo, hisobotlar. Boshqa savollar uchun uzr. <i class='fas fa-info-circle'></i>"],
                    nima_qila_olasiz: ["RailSafe tizimi haqida ma'lumot beraman, hisobotlar tayyorlayman, ob-havo bashorati qilaman, diagnostika va xavfsizlik maslahatlari beraman. Ovozli javob beraman! <i class='fas fa-rocket'></i>"],
                    ob_havo: ["Ob-havo: Quyoshli, 25-28°C. Poyezdlar uchun ideal. Stansiya ayting batafsil uchun. Namlik: 40%. <i class='fas fa-cloud-sun'></i>"],
                    bashorat: ["Ertaga yomg'irli, 18-22°C. Sensorlar namlikni kuzatadi. Ehtiyot bo'ling! Shamol tezligi: 10 km/soat. <i class='fas fa-umbrella'></i>"],
                    kechikish: ["Kechikish ehtimoli: 5%. Real vaqt monitoring. Sababi: ob-havo yoki texnik muammo. <i class='fas fa-clock'></i>"],
                    hisobot: ["Hisobot tayyorlanmoqda... PDF yuklab oling. Batafsil statistika va grafiklar. <i class='fas fa-file-pdf'></i>"],
                    texnik: ["Texnik masalalar: Sensorlarni kalibrlash kerak. Maslahat: Har 24 soatda tekshiruv o'tkazing. <i class='fas fa-wrench'></i>"],
                    maslahat: ["Xavfsizlik maslahati: Poyezd yaqinlashganda masofani saqlang. Harorat oshishida darhol ogohlantiring. <i class='fas fa-lightbulb'></i>"],
                    statistika: ["Statistika: O'tgan oyda 500 ta poyezd, 0 ta voqea. Yillik o'sish: 10%. <i class='fas fa-chart-bar'></i>"],
                    yangiliklar: ["Yangiliklar: Yangi AI tizimi o'rnatildi. Xavfsizlik darajasi 99%. <i class='fas fa-newspaper'></i>"],
                    tizim: ["Tizim haqida: RailSafe AI - sun'iy intellekt asosida temir yo'lni nazorat qiladi. Versiya: 2.0. <i class='fas fa-cogs'></i>"],
                    default: ["Bu savolga javobim yo'q. RailSafe mavzusida so'rang. Masalan, stansiya holati yoki ob-havo. <i class='fas fa-search'></i>"]
                },
                lang: 'uz-UZ'
            }
        };
        let currentLang = 'uz';
        let chatContext = {
            lastTopic: null,
            currentStation: null,
            trainCount: { left: 12, right: 15 },
            weatherData: {
                toshkent: { today: 'Quyoshli, 25-28°C', tomorrow: 'Bulutli, 20-24°C' },
                samarqand: { today: 'Ochiq, 24-27°C', tomorrow: 'Yomg\'irli, 18-22°C' },
                buxoro: { today: 'Issiq, 26-30°C', tomorrow: 'Shamolli, 22-26°C' },
                navoiy: { today: 'Quyoshli, 27-30°C', tomorrow: 'Bulutli, 23-26°C' },
                jizzax: { today: 'Ochiq, 25-28°C', tomorrow: 'Yomg\'irli, 20-23°C' },
                guliston: { today: 'Issiq, 26-29°C', tomorrow: 'Shamolli, 22-25°C' },
                kungrad: { today: 'Quyoshli, 28-31°C', tomorrow: 'Bulutli, 24-27°C' },
                urgench: { today: 'Ochiq, 27-30°C', tomorrow: 'Yomg\'irli, 23-26°C' },
                andijon: { today: 'Issiq, 24-27°C', tomorrow: 'Shamolli, 20-23°C' },
                fargona: { today: 'Quyoshli, 25-28°C', tomorrow: 'Bulutli, 21-24°C' },
                termiz: { today: 'Ochiq, 29-32°C', tomorrow: 'Yomg\'irli, 25-28°C' },
                qarshi: { today: 'Issiq, 28-31°C', tomorrow: 'Shamolli, 24-27°C' },
                nukus: { today: 'Quyoshli, 27-30°C', tomorrow: 'Bulutli, 23-26°C' },
                xiva: { today: 'Ochiq, 26-29°C', tomorrow: 'Yomg\'irli, 22-25°C' }
            },
            conversationHistory: []
        };
        const stations = [
            { id: "blok-post-kattakurgan", name: "Блок-Пост-Каттакурган", coords: [39.9024, 66.2457], description: "Kattakurgan blok-posti, Samarqand viloyati" },
            { id: "kattakurgan-rzd28", name: "Каттакурган-Рзд№28", coords: [39.8800, 66.2800], description: "Raz'ezd N28 Kattakurgan yaqinida, Samarqand viloyati" },
            { id: "nurbulak-blok-post", name: "Нурбулак-Блок-пост", coords: [39.8500, 66.4068], description: "Nurbulak blok-posti, Nurobod tumani" },
            { id: "rzd24-nurbulak", name: "Рзд№24-Нурбулак", coords: [39.7000, 66.8000], description: "Raz'ezd N24 Nurbuloq yaqinida, Pastdarg'om tumani" },
            { id: "yangiyul-paxta", name: "Янгийўл-Пахта", coords: [41.0139, 68.9449], description: "Paxta stansiyasi (Yangiyo'l-Paxta bo'limi), Toshkent viloyati" },
            { id: "paxta-almazor", name: "Пахта-Алмазар", coords: [40.9621, 68.8583], description: "Almazor stansiyasi (Paxta-Almazor bo'limi), Toshkent viloyati" },
            { id: "tashkent", name: "Ташкент", coords: [41.3111, 69.2406], description: "Toshkent temir yo'l stansiyasi, Toshkent shahri" },
            { id: "samarkand", name: "Самарканд", coords: [39.6825, 66.9286], description: "Samarqand temir yo'l stansiyasi, Samarqand viloyati" },
            { id: "bukhara", name: "Бухара", coords: [39.7164, 64.5511], description: "Buxoro temir yo'l stansiyasi, Buxoro viloyati" },
            { id: "navoi", name: "Навои", coords: [40.1, 65.3667], description: "Navoiy temir yo'l stansiyasi, Navoiy viloyati" },
            { id: "jizzak", name: "Джизак", coords: [40.133, 67.833], description: "Jizzax temir yo'l stansiyasi, Jizzax viloyati" },
            { id: "gulistan", name: "Гулистан", coords: [40.4915, 68.7811], description: "Guliston temir yo'l stansiyasi, Sirdaryo viloyati" },
            { id: "kungrad", name: "Кунград", coords: [43.0425, 58.8503], description: "Kungrad temir yo'l stansiyasi, Qoraqalpog'iston Respublikasi" },
            { id: "urgench", name: "Ургенч", coords: [41.55, 60.6333], description: "Urganch temir yo'l stansiyasi, Xorazm viloyati" },
            { id: "andijan", name: "Андижан", coords: [40.7821, 72.3442], description: "Andijon temir yo'l stansiyasi, Andijon viloyati" },
            { id: "fergana", name: "Фергана", coords: [40.3844, 71.7864], description: "Farg'ona temir yo'l stansiyasi, Farg'ona viloyati" },
            { id: "termez", name: "Термез", coords: [37.2611, 67.3086], description: "Termiz temir yo'l stansiyasi, Surxondaryo viloyati" },
            { id: "karshi", name: "Карши", coords: [38.8667, 65.8], description: "Qarshi temir yo'l stansiyasi, Qashqadaryo viloyati" },
            { id: "nukus", name: "Нукус", coords: [42.4531, 59.6103], description: "Nukus temir yo'l stansiyasi, Qoraqalpog'iston Respublikasi" },
            { id: "xiva", name: "Хива", coords: [41.3833, 60.35], description: "Xiva temir yo'l stansiyasi, Xorazm viloyati" }
        ];
        let recognition;
        let isListening = false;
        let isSpeaking = false;

        function initRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = translations.uz.lang;
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.maxAlternatives = 1;
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                    document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-stop-circle"></i>';
                };
                recognition.onresult = (event) => {
                    let transcript = event.results[0][0].transcript.trim().toLowerCase();
                    addMessage(transcript, 'user');
                    chatContext.conversationHistory.push({ user: transcript, time: new Date().toLocaleTimeString() });
                    sendMessage(transcript);
                };
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('voiceBtn').classList.remove('listening');
                    document.getElementById('voiceBtn').innerHTML = '<i class="fas fa-microphone"></i>';
                };
                recognition.onerror = (event) => {
                    console.error('Ovoz xatosi:', event.error);
                    if (event.error !== 'aborted') {
                        addMessage("Ovoz aniqlashda xato yuz berdi. Iltimos, qayta urinib ko'ring.", 'bot');
                        speak("Ovoz aniqlashda xato yuz berdi. Iltimos, qayta urinib ko'ring.");
                    }
                };
            } else {
                addMessage("Ovozli kirish brauzeringizda qo'llab-quvvatlanmaydi.", 'bot');
            }
        }

        function setLanguage() {
            document.documentElement.lang = 'uz';
            document.getElementById('chat-title').innerHTML = translations.uz.title;
            document.getElementById('chat-subtitle').innerHTML = translations.uz.subtitle;
            document.getElementById('typing-text').textContent = translations.uz.typing;
            initRecognition();
            clearChat(true);
            addInitialMessage();
        }

        function addMessage(text, sender, delay = 0) {
            setTimeout(() => {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                const avatarClass = sender === 'bot' && isSpeaking ? 'bot-avatar speaking' : `${sender}-avatar`;
                messageDiv.innerHTML = `
                    <div class="avatar ${avatarClass}">${sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>'}</div>
                    <div class="bubble">${text}</div>
                `;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, delay);
        }

        function addInitialMessage() {
            addMessage(translations.uz.initial, 'bot');
            speak(translations.uz.initial);
        }

        function showTyping(show) {
            document.getElementById('typingIndicator').style.display = show ? 'flex' : 'none';
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'uz-UZ';
                utterance.rate = 0.9; // Yaxshiroq aksent uchun sekinroq
                utterance.pitch = 1.1; // O'zbekcha aksentni yaxshilash uchun ozroq o'zgartirish
                utterance.volume = 1.0;
                utterance.onstart = () => {
                    isSpeaking = true;
                    document.querySelector('.bot-avatar')?.classList.add('speaking');
                };
                utterance.onend = () => {
                    isSpeaking = false;
                    document.querySelector('.bot-avatar')?.classList.remove('speaking');
                    console.log('Ovoz tugadi');
                };
                speechSynthesis.speak(utterance);
            }
        }

        function getResponse(input) {
            input = input.toLowerCase().trim();
            const keywords = ['rail', 'safe', 'temir', 'yo\'l', 'stansiya', 'poyezd', 'diagnostika', 'holat', 'sensor', 'log', 'xavfsizlik', 'ob', 'havo', 'bashorat', 'kechikish', 'jadval', 'voqea', 'hisobot', 'texnik', 'maslahat', 'statistika', 'yangiliklar', 'tizim'];
            if (!keywords.some(k => input.includes(k))) {
                return translations.uz.responses.default;
            }
            const keys = Object.keys(translations.uz.responses);
            for (let key of keys) {
                if (input.includes(key)) {
                    let reply = translations.uz.responses[key][Math.floor(Math.random() * translations.uz.responses[key].length)];
                    if (input.includes('stansiya')) {
                        const stationNames = stations.map(s => s.name.toLowerCase());
                        const foundStation = stationNames.find(name => input.includes(name));
                        if (foundStation) {
                            const station = stations.find(s => s.name.toLowerCase() === foundStation);
                            chatContext.currentStation = station;
                            reply += ` ${station.name} stansiyasi: ${station.description}. Koordinatalar: ${station.coords.join(', ')}. Holat: stabil.`;
                        }
                    }
                    if (key === 'hisobot' && chatContext.currentStation) {
                        reply += ` ${chatContext.currentStation.name} stansiyasi uchun hisobot tayyorlanmoqda...`;
                        generatePDF(chatContext.currentStation);
                    } else if (key === 'hisobot') {
                        reply += ' Hisobot uchun stansiya nomini ayting.';
                    }
                    if (key === 'ob_havo' || key === 'bashorat') {
                        let stationKey = 'toshkent';
                        for (let sk of Object.keys(chatContext.weatherData)) {
                            if (input.includes(sk)) {
                                stationKey = sk;
                                break;
                            }
                        }
                        const data = chatContext.weatherData[stationKey];
                        reply += ` ${stationKey.charAt(0).toUpperCase() + stationKey.slice(1)} uchun: Bugun ${data.today}, ertaga ${data.tomorrow}. AI maslahati: Harorat o'zgarishiga e'tibor bering.`;
                    }
                    if (chatContext.conversationHistory.length > 1) {
                        reply += ` Oldingi suhbatga ko'ra, qo'shimcha ma'lumot: ${Math.floor(Math.random() * 10) + 1} ta yangi o'zgarish.`;
                    }
                    chatContext.lastTopic = key;
                    chatContext.conversationHistory.push({ bot: reply, time: new Date().toLocaleTimeString() });
                    return reply;
                }
            }
            return translations.uz.responses.yordam;
        }

        async function generatePDF(station) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("helvetica", "normal");
            doc.setFontSize(18);
            doc.text("RailSafe Hisoboti", 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text(`Stansiya: ${station.name}`, 20, 40);
            doc.text(`Tavsif: ${station.description}`, 20, 50);
            doc.text(`Koordinatalar: ${station.coords.join(', ')}`, 20, 60);
            doc.setFontSize(12);
            doc.text("Diagnostika Holati:", 20, 80);
            doc.text("Chap tizim: Normal (42°C)", 30, 90);
            doc.text("O'ng tizim: Ogohlantirish (65°C)", 30, 100);
            doc.text("O'tgan Poyezdlar: 27 ta", 20, 110);
            doc.text("Ob-havo: Quyoshli, 25-28°C", 20, 120);
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 200;
            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['06:00', '09:00', '12:00', '15:00', '18:00'],
                    datasets: [{
                        label: 'Harorat (°C)',
                        data: [30, 42, 50, 65, 55],
                        borderColor: '#003366',
                        fill: false
                    }]
                },
                options: { responsive: false }
            });
            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 20, 130, 170, 60);
            doc.save(`${station.name}_hisobot.pdf`);
        }

        function getForecast() {
            const stationsList = Object.keys(chatContext.weatherData);
            const randomStation = stationsList[Math.floor(Math.random() * stationsList.length)];
            const data = chatContext.weatherData[randomStation];
            const reply = `AI bashorati: ${randomStation.charAt(0).toUpperCase() + randomStation.slice(1)} da ertaga ${data.tomorrow}. Sensorlar namlikni kuzatadi. Ehtiyot bo'ling! <i class='fas fa-umbrella'></i>`;
            addMessage(reply, 'bot');
            speak(reply);
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            const icon = document.querySelector('.theme-toggle i');
            icon.classList.toggle('fa-moon', currentTheme === 'light');
            icon.classList.toggle('fa-sun', currentTheme === 'dark');
        }

        function sendMessage(input) {
            if (!input) return;
            showTyping(true);
            setTimeout(() => {
                const reply = getResponse(input);
                showTyping(false);
                addMessage(reply, 'bot');
                speak(reply);
            }, 800 + Math.random() * 1500);
        }

        function clearChat(silent = false) {
            if (!silent && !confirm('Chatni tozalamoqchimisiz?')) return;
            document.getElementById('messages').innerHTML = '';
            chatContext = {
                lastTopic: null,
                currentStation: null,
                trainCount: { left: 12, right: 15 },
                weatherData: chatContext.weatherData,
                conversationHistory: []
            };
            if (!silent) addInitialMessage();
        }

        document.getElementById('voiceBtn').addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        window.onload = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'dark') {
                document.querySelector('.theme-toggle i').classList.replace('fa-moon', 'fa-sun');
            }
            setLanguage();
        };
    </script>
</body>
</html>
